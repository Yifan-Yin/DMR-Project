---
title: "shiny_DMR"
output: html_document
---

#set up
```{r}
#install.packages('rsconnect')
library(rsconnect)
library(shiny)
rsconnect::setAccountInfo(name='yifan7', token='52E1037550A7AA68252579A98EE8AA38', secret='+NlrJysSVZHa5LQQb9slmYRDXExPfjF0QbxMjUH1')
library(DT)
```

#ui
```{r}
ui <- fluidPage(
  #main title
  titlePanel("Placental Cell Methylome Browser"),
  br(), # create a space line
  br(),
  hr(), #create a line
  
  #UI layout
  sidebarLayout(
  sidebarPanel(
    
           #miRNA name input
           selectizeInput('name', 'CpG Site', choices = NULL,multiple = TRUE,options = list(placeholder='Enter CpG site names' )),
           #create action button
  
           selectizeInput('gene', 'Gene', choices = NULL, multiple = TRUE,options = list(placeholder='Enter a gene name',onInitialize = I('function() { this.setValue(""); }'))),
           actionButton("submit", "Submit"),
           br(), # add a space line
           br(), # add a space line
           hr(),#create a horizontal line
           checkboxGroupInput('checkbox', 'Information in table to show', names(anno1), selected = names(anno1)[-10:-12])
          
           ), 
  
  mainPanel(
  hr(),
  #create a data table to show cpg site information 
  div(dataTableOutput('info'), style = "font-size:85%"),
  plotOutput('plot_cpg', height = '500px'),
  #boxplot that shows tissue and trimester
  plotOutput('boxplot_tissue_total',  height = '500px', width = '95%'),
  plotOutput('boxplot_trimester_total',  height = '500px', width = '95%'),
  plotOutput('boxplot_tissue_individual', width = '95%')
  )
  )
)

server <- function(input, output, session) {
    #searching list
    updateSelectizeInput(session = session, inputId = 'name', choices = cpg$value, server = TRUE)
    updateSelectizeInput(session = session, inputId = 'gene', choices = gene$gene, server = TRUE)
      
    #produce output when click submit button
    event_submit <- eventReactive(input$submit, {input$name})
    event_submit2 <- eventReactive(input$submit, {input$gene})
    empty_df <- anno[0,]
    #related cpg site
    b <- reactive(fn_cpg(event_submit2()))

    #cpg site information datatable
    output$info <- DT::renderDataTable(
      { if (input$submit == FALSE) return(DT:: datatable(empty_df, options = list(paging = FALSE, searching = FALSE)))
        DT::datatable(cpg_info_total(cpg_name = event_submit(), gene_name = event_submit2())[,input$checkbox, drop = FALSE], options = list(pageLength = 5),
        selection = 'single',
        rownames = FALSE,
        
        callback = JS("table.on('click.dt', 'tr',
                  function() {
                  Shiny.onInputChange('rows', table.rows('.selected').data().toArray());
                  });"))%>% formatStyle(1, cursor = 'pointer')
       
      }
    )

    #boxplot
    ##retrive cpg name when click the datatable
    event_cpg <- eventReactive(input$info_cell_clicked, {c_info = input$info_cell_clicked
    c_info$value})
  
    #boxplot
    output$boxplot_tissue_total <- renderPlot(
      { 
        boxplot_tissue_total(cpg_name = event_submit(), gene_name = event_submit2())
      }
    )
    output$boxplot_trimester_total <- renderPlot(
      {

          boxplot_trimester_total(cpg_name = event_submit(), gene_name = event_submit2())
        
      }
    )
    output$boxplot_tissue_individual <- renderPlot(
      {
        if (!is.null(event_cpg()))
        {
          boxplot_individual_cpg(event_cpg())
        }
      }
    )

    output$plot_cpg <- renderPlot(
      {
        plot_cpgs_in_gene(gene = event_submit2())
      }
    )

}
shinyApp(ui, server)
```

