---
title: "DMC Visualization"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#setup

```{r}
library(pheatmap)
library(bumphunter)
library(XML)
library(xlsx)  
library(readxl)
library(stringr)
library(yahew)  # library(devtools); install_github('wvictor14/yahew')
library(minfi) # for loading methyldation data
library(dplyr)
library(IlluminaHumanMethylation450kanno.ilmn12.hg19) # for cpg info
library(IlluminaHumanMethylation450kmanifest)
library(kableExtra)
library(ggplot2)
library(ggpubr)
library(fdrtool)
library(microbenchmark)
library(reshape2) 
```

#data setup
```{r}
#read DMC values from all tests
DMC_alltest <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_2_Term_DMCs_alltests.rds')
#read processed DMC values
data <- read_xlsx('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_2_Term_DMCs.xlsx')
#read beta values from all tests
beta <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_2_betas_term.rds')
#pull out beta values from DM cpg sites
beta <- as.data.frame(beta)
beta_DMC <- beta[rownames(beta)%in% data$cpg,]

#check if the samples are the same
all(data$cpg%in% rownames(beta_DMC))
all(rownames(beta_DMC)%in% data$cpg)

#pull out cpg site name for the search list use
cpgname <- data$cpg

#pull out gene name for the search list use
gene <- as.matrix(data$UCSC_RefGene_Name)
a <- apply(gene, 1, strsplit,';')
a <- unlist(a)
gene <- a[!duplicated(a)]
gene <- gene[!is.na(gene)]
gene <- as.data.frame(gene)

#for test use
cpg_1 <-c("cg23235736", "cg17315703", "cg14623715")

gene_1 <- c('PARN','PCID2')
```


#boxplot
##only cpg input
```{r}
#Single plot function (produce a boxplot when click the cpg site name)
boxplot_singleplot <- function(cpg_name){
    #get input cpg site beta values
    cpg <- filter(beta, rownames(beta) %in% cpg_name)
    rownames(cpg) <- cpg_name
    
    #get sample cell types
    cpg <- colnames(cpg) %>% substr(7,15) %>% rbind(cpg)
    cpg <- t(cpg) %>% as_tibble() 
    colnames(cpg)[1] <- 'cell_types'
    cpg <- cpg %>% filter(!cell_types == 'vc' & !cell_types =='tro2' & !cell_types == 'vc_R1')
    cpg$cell_types <- as.factor(cpg$cell_types)
    cpg[,2:(length(cpg_name)+1)] <- select(cpg, -cell_types) %>% apply(2, as.numeric)
    
    #reshape data for producing multiple boxplots
    cpg <- melt(cpg, id = 'cell_types')
    
    #boxplot
    ggplot(cpg)+geom_boxplot(aes(x=cell_types, y=value, fill = cell_types))+facet_wrap(.~variable)+ theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust =1))+labs(x = 'Cell Types', y ='beta')
}
#information for producing boxplot which shows beta values of input cpg sites
boxplot_cpg <- function(cpg_name){
    #get input cpg site beta values
    cpg <- filter(beta, rownames(beta) %in% cpg_name)
    rownames(cpg) <- cpg_name
    
    #get sample cell types
    cpg <- colnames(cpg) %>% substr(7,15) %>% rbind(cpg)
    cpg <- t(cpg) %>% as_tibble() 
    colnames(cpg)[1] <- 'cell_types'
    cpg <- cpg %>% filter(!cell_types == 'vc' & !cell_types =='tro2' & !cell_types == 'vc_R1')
    cpg$cell_types <- as.factor(cpg$cell_types)
    cpg[,2:(length(cpg_name)+1)] <- select(cpg, -cell_types) %>% apply(2, as.numeric)
    
    #reshape data for producing multiple boxplots
    cpg <- melt(cpg, id = 'cell_types')
    
    cpg
}
```
##only gene input
```{r}
#information for producing boxplot which shows beta values of cpg sites related input genes
boxplot_gene <- function(gene_name){
   
    #get cpgs sites related to input genes
    cpg_name <- filter(DMC_alltest, grepl(gene_name, UCSC_RefGene_Name))
    cpg_name <- cpg$cpg %>% unique()

    cpg <- boxplot_cpg(cpg_name)
    cpg
}

```
##both cpg and gene input
```{r}
#boxplot
boxplot_total <- function(cpg_name = NULL, gene_name = NULL){
  #when only have gene input
  if(is.null(cpg_name)){
  cpg <- boxplot_gene(gene_name)
  }
  
  #when only have cpg input
  else if(is.null(gene_name)){
  cpg <- boxplot_cpg(cpg_name)  
  }
  
  #when have both cpg and gene input
  else{
  cpg <- rbind(boxplot_cpg(cpg_name),boxplot_gene(gene_name))
  }
  #boxplot
ggplot(cpg,aes(x=cell_types, y=value))+geom_boxplot(aes(fill = cell_types))+facet_wrap(.~variable)+ theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust =1))+labs(x = 'Cell Types', y ='beta', fill = 'Cell Types')
}

```


#datatable
##only cpg input
```{r}
#datatable which shows all DMC tests
cpg_info <- function(cpg_name){
#get input cpg site information
cpg <- filter(DMC_alltest, cpg %in% cpg_name) %>% arrange(cpg)

cpg
}
#datatable which shows only significant tests
cpg_info_sig <- function(cpg_name){
#get input cpg site information
cpg <- filter(data, cpg %in% cpg_name) 
  
cpg
}
```
##only gene input
```{r}
#datatable shows all cpg sites related to input gene
cpg_info_gene <- function(gene_name){

    #get cpgs sites related to input genes
    cpg_name <- filter(DMC_alltest, grepl(gene_name, UCSC_RefGene_Name))
    cpg_name <- cpg$cpg %>% unique()

  cpg <- filter(DMC_alltest, cpg %in% cpg_name)%>% arrange(cpg)
  cpg
}

#datatable shows significant cpg sites related to input gene
cpg_info_sig_gene <- function(gene_name){

    #get cpgs sites related to input genes
    cpg_name <- filter(data, grepl(gene_name[i], UCSC_RefGene_Name))
    cpg_name <- cpg$cpg %>% unique()

    cpg <- filter(data, cpg %in% cpg_name) %>% arrange(cpg)

cpg
}
```
##both input and gene input
```{r}
#datatable shows all tests
cpg_info_total <- function(cpg_name = NULL, gene_name = NULL){
    if (is.null(cpg_name)){
      info <- cpg_info_gene(gene_name)
    }
    else if (is.null(gene_name)){
      info <- cpg_info(cpg_name)
    }
    else {
      info1 <- cpg_info(cpg_name)
      info2 <- cpg_info_gene(gene_name)
      info <- merge(info1, info2, all= TRUE)
    }
  info
}

#datatable shows only significant tests
cpg_info_total_sig <- function(cpg_name = NULL, gene_name = NULL){
    if (is.null(cpg_name)){
      info <- cpg_info_sig_gene(gene_name)
    }
    else if (is.null(gene_name)){
      info <- cpg_info_sig(cpg_name)
    }
    else {
      info1 <- cpg_info_sig(cpg_name)
      info2 <- cpg_info_sig_gene(gene_name)
      info <- merge(info1, info2, all= TRUE)
    }
  info
}
```


#heatmap
##only cpg input
```{r}
#heatmap to view test result
heatmap_cpg <- function(cpg_name){

  cpg <- filter(DMC_alltest, cpg %in% cpg_name)
  
    cpg<- select(cpg, cpg, Cell_type, bonferroni,estimate_b)
    acc <- NULL
    for (i in 1:nrow(cpg))
    {
      if(cpg[i,3] < 0.001 & abs(cpg[i,4]) >0.5)
      {
        bool <- 1
      }
      else
      {
        bool <- 0
      }
      acc <- c(acc, bool)
    }
    cpg <- mutate(cpg, bool = acc)
    cpg$cpg <- as.character(cpg$cpg)
    cpg$cpg <- factor(cpg$cpg, levels = unique(cpg$cpg))
    cpg$Cell_type <- as.factor(cpg$Cell_type)
    cpg$bool<- as.factor(cpg$bool)
cpg
}
```
##only gene input
```{r}
#heatmap
heatmap_gene <- function(gene_name){

    #get cpgs sites related to input genes
    cpg_name <- filter(DMC_alltest, grepl(gene_name[i], UCSC_RefGene_Name))
    cpg_name <- cpg$cpg %>% unique()

    cpg <- heatmap_cpg(cpg_name)
    cpg
}
```
#both cpg and gene input
```{r}
#heatmap
heatmap_total <- function(cpg_name = NULL, gene_name = NULL){
  if (is.null(cpg_name)){
  cpg <- heatmap_gene(gene_name)
  plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types', fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant'))
  plot
  }
  else if (is.null(gene_name)){
  cpg <- heatmap_cpg(cpg_name)
  plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types',fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant'))  
  plot
  }
  else{
    gene_data <- heatmap_gene(gene_name)
    cpg_data <- heatmap_cpg(cpg_name)
    cpg <- merge(gene_data, cpg_data, all = TRUE)
    plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types',fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant')) 
    plot
  }
}
```

