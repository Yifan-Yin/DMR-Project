---
title: "DMC_alltest Visualization"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#package setup

```{r}
library(RColorBrewer)
library(kableExtra)
library(readr)
library(tidyverse)
library(reshape2)
library(cowplot)
library(ggpubr)
```

#data setup
```{r}
#read cpg annotation info
anno <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\3_1_annotation.rds')
ref_group <- anno[, c(1,12:19)]
anno <- anno[, -12:-19]

#mean and SD data
stat <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\3_1_betas_cell_mean_sd.rds')

#read cpg methylation data
beta <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\1_4_betas_noob_filt_XYkeep.rds')

#pData
pDat <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_3_pDat_contam.rds')
pDat <- pDat %>%
    mutate(Tissue = case_when(
    !(Tissue %in% c('Villi', 'Villi maternal', 'Syncytiotrophoblast')) ~ paste(Tissue, 'cs'),
    Tissue == 'Syncytiotrophoblast' ~ 'Trophoblasts enz',
    TRUE ~ Tissue)) %>% 
    filter(Tissue %in% c('Endothelial cs', 'Hofbauer cs','Stromal cs', 'Trophoblasts cs', 'Trophoblasts enz','Villi')) %>% 
    select(Trimester, Tissue, Sentrix)

#color code
color_code <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_3_color_code.rds')
color_code_tissue <- setNames(color_code$Colors_Tissue, color_code$label)
colors <- color_code_tissue[unique(pDat$Tissue)]

#pull out gene name for search list use
gene <- tibble(gene = str_split(anno$genes_symbol, ', ') %>%
        unlist() %>%
         unique()) %>%
  filter(!is.na(gene))
#pull out cpg name for search list use
cpg <- unique(anno$cpg) %>%tibble()

#for test use
cpg_1 <-c("cg23235736", "cg17315703", "cg14623715")

gene_1 <- c('PCID2')
```


#beta boxplot
##Main function1(produce a single plot when clicking a cpg site name)
```{r}
#combine tissue and trimester plots
boxplot_single <- function(cpg_name = NULL){
  plot1 <- boxplot_tissue_single(cpg_name = cpg_name)
  plot2 <- boxplot_trimester_single(cpg_name = cpg_name)
  
  plot <- plot_grid(ggarrange(plot1 + theme(legend.position = ''), 
                              plot2 + theme(legend.position = ''), 
                              nrow = 2, align = 'hv'),
                    plot_grid(get_legend(plot1), 
                    get_legend(plot2), 
                    ncol = 1, align = 'hv'), 
                    ncol = 2,rel_widths = c(5,1)
                    )
  plot
}

#boxplots which show beta values based on cell types
boxplot_tissue_single <- function(cpg_name){
  
    #get sample cell types and trimester
    cpg <- sample_info_cpg(cpg_name)
    
    #boxplot
    boxplot_tissue(cpg)
}
#boxplot which show beta values based on trimester
boxplot_trimester_single <- function(cpg_name){
  
    #get sample cell types and trimester
    cpg <- sample_info_cpg(cpg_name)
    
    #boxplot
    boxplot_trimester(cpg)
}
```

##Main function2(produce boxplots when having multiple cpg sites)
```{r}
#combine tissue and trimester plots
boxplot_total <- function(cpg_name = NULL, gene_name = NULL){
  plot1 <- boxplot_tissue_total(cpg_name = cpg_name, gene_name = gene_name)
  plot2 <- boxplot_trimester_total(cpg_name = cpg_name, gene_name = gene_name)
  
  plot <- plot_grid(ggarrange(plot1 + theme(legend.position = ''), 
                              plot2 + theme(legend.position = ''), 
                              nrow = 2, align = 'hv'),
                    plot_grid(get_legend(plot1), 
                    get_legend(plot2), 
                    ncol = 1, align = 'hv'), 
                    ncol = 2,rel_widths = c(5,1)
                    )
  plot
}

#boxplot to show different tissue types
boxplot_tissue_total <- function(cpg_name = NULL, gene_name = NULL){
  #when only have gene inputs
  if(is.null(cpg_name)){
  cpg <- sample_info_gene(gene_name)
  }
  
  #when only have cpg inputs
  else if(is.null(gene_name)){
  cpg <- sample_info_cpg(cpg_name)  
  }
  
  #when have both cpg and gene input
  else{
  cpg <- rbind(sample_info_cpg(cpg_name),sample_info_gene(gene_name))
  }
  #boxplot
  boxplot_tissue(cpg)
}

#boxplot to show different trimesters
boxplot_trimester_total <- function(cpg_name = NULL, gene_name = NULL){
  #when only have gene input
  if(is.null(cpg_name)){
  cpg <- sample_info_gene(gene_name)
  }
  
  #when only have cpg input
  else if(is.null(gene_name)){
  cpg <- sample_info_cpg(cpg_name)  
  }
  
  #when have both cpg and gene input
  else{
  cpg <- rbind(sample_info_cpg(cpg_name),sample_info_gene(gene_name))
  }
  #boxplot
  boxplot_trimester(cpg)
}

```

##pull out cpg information(beta, tissue and trimester)
```{r}
#get sample information (beta, tissue and trimester)
sample_info_cpg <- function(cpg_name){
    
    cpg <- beta[cpg_name,]
    #when have only one cpg input
    if (length(cpg_name) ==1){
    cpg <- as.data.frame(cpg) %>% t()
    cpg <- cpg[,colnames(cpg) %in% pDat$Sentrix]
    cpg <- as.data.frame(cpg)
    colnames(cpg) <- cpg_name
    cpg <- cpg %>% cbind(pDat) %>% gather(cpg, beta, contains('cg'))
    }
    #when have more than one cpg inputs
    else{
    cpg <- cpg[,colnames(cpg) %in% pDat$Sentrix]
    cpg <- cpg %>% t() %>% cbind(pDat) %>% gather(cpg, beta, contains('cg'))
    }
    cpg
}   

```

##pull out information of cpgs that are related to a gene
```{r}
#information for producing boxplot which shows beta values of cpg sites related input genes
sample_info_gene <- function(gene_name){
  #get related cpg sites
  cpg_name <- fn_cpg(gene_name)
  #get sample cell types and tri
  cpg <- sample_info_cpg(cpg_name)
  cpg
}
```

###get related cpg sites
```{r}
fn_cpg <- function(gene_name){
  cpg_name <- anno[grepl(gene_name, anno$genes_symbol),]
  cpg_name <- cpg_name$cpg %>% unique()
  cpg_name
}

```

##ggplot function
```{r}
#boxplot function
boxplot_tissue <- function(cpg){
  ggplot(cpg, aes(x=Tissue, y=beta, fill = Tissue)) +
      geom_violin()+
      geom_jitter(aes(color = Tissue), alpha = 0.5, show.legend = F) +
      facet_wrap(.~cpg)+ 
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust =1))+
      labs(x = 'Tissue', y ='beta') +scale_fill_manual(values = colors) + scale_color_manual(values = colors) + ylim(0,1)
}

boxplot_trimester <- function(cpg){
  ggplot(cpg, aes(x=Trimester, y=beta, fill = Trimester)) +
      geom_violin()+
      geom_jitter(aes(color = Trimester), alpha = 0.5, show.legend = F) +
      facet_wrap(.~cpg)+ 
      labs(x = 'Trimester', y ='beta')  +ylim(0,1)
}
```


#datatable which shows cpg annotation
##Main function
```{r}
#datatable which shows cpg annotation (when inputs have both cpgs and genes)
cpg_info_total <- function(cpg_name = NULL, gene_name = NULL){
    if (is.null(cpg_name)){
      info <- cpg_info_gene(gene_name)
    }
    else if (is.null(gene_name)){
      info <- cpg_info(cpg_name)
    }
    else {
      info1 <- cpg_info(cpg_name)
      info2 <- cpg_info_gene(gene_name)
      info <- merge(info1, info2, all= TRUE)
    }
  info
}
```

##when input only cpgs
```{r}
#datatable which shows cpg annotation
cpg_info <- function(cpg_name){

  cpg <- filter(anno, cpg %in% cpg_name) %>% arrange(cpg)

cpg
}
```

##when input only genes
```{r}
#datatable shows all cpg sites related to input gene
cpg_info_gene <- function(gene_name){

  #get cpgs sites related to input genes
  cpg_name <- fn_cpg(gene_name)
  
  cpg <- filter(anno, cpg %in% cpg_name)%>% arrange(cpg)
  cpg
}
```


#plots to view mean and SD
##Main function
```{r}
ref_group <- ref_group %>% gather(key = 'gene_id', value = 'value', -cpg)
overview_tissue <- function(cpg_name = NULL, gene_name = NULL){
  if (is.null(cpg_name)){
  cpg <- fn_cpg(gene_name)
  plot <- overview_tissue_cpg(cpg)
  plot
  }
  else if (is.null(gene_name)){
  plot <- overview_tissue_cpg(cpg_name)
  plot
  }
  else{
  cpg <- gene_name %>% fn_cpg() %>% c(cpg_name)
  plot <- overview_tissue_cpg(cpg)
  plot
  }
}

overview_trimester <- function(cpg_name = NULL, gene_name = NULL){
  if (is.null(cpg_name)){
  cpg <- fn_cpg(gene_name)
  plot <- overview_tissue_cpg(cpg)
  plot
  }
  else if (is.null(gene_name)){
  plot <- overview_trimester_cpg(cpg_name)
  plot
  }
  else{
  cpg <- gene_name %>% fn_cpg() %>% c(cpg_name)
  plot <- overview_trimester_cpg(cpg)
  plot
  }
}
```

##ggplot function
```{r}
overview_tissue_cpg <- function(cpg_name){
  plot1 <- heatmap_ref(cpg_name)
  
  plot2 <- lineplot(cpg_name)
  
  plot <- plot_grid(ggarrange( 
                    plot1 + theme(legend.position = ''),
                    plot2 + theme(legend.position = '') + labs(y = 'methylation%', x =''),
                    nrow = 2, widths = c(0.25, 3), align = 'h'),
          plot_grid(get_legend(plot1), 
                    get_legend(plot2), 
                    ncol = 1, align = 'hv'), 
          ncol = 2, rel_widths = c(5,1))
  plot

  plot
}


#line plot to view mean and sd
lineplot <- function(cpg_name){
  
  plot <- stat %>% filter(cpg %in% cpg_name) %>% mutate(lower = mean -sd, upper = mean +sd) %>%
  ggplot() +
  geom_linerange(alpha = 0.75, size = 1, aes(x = cpg, ymin =(lower)*100, ymax = (upper)*100, color = Tissue)) +
  geom_point(alpha = 0.75, aes(x = cpg, y = (mean) *100, color = Tissue), size = 2) +
  theme_bw() +
  theme(plot.margin=margin(l= 0.5,unit="cm")) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_x_discrete(expand = c(0.01,0.01))+
  labs(y = '', x = '') +
  scale_fill_manual(values = colors) + 
  scale_color_manual(values = colors)
  
  plot
}

#heatmap to view gene reference group
heatmap_ref <- function(cpg_name){
  
  cpg <- filter(ref_group, ref_group$cpg %in% cpg_name) %>% 
    mutate(value = factor(as.character(value), levels = as.character(unique(value))), 
           gene_id = factor(as.character(gene_id), levels = as.character(unique(gene_id))), 
           cpg = factor(as.character(cpg), levels = as.character(unique(cpg))))%>% 
    ggplot(aes(x = cpg, y = gene_id, fill = value)) +
    geom_tile(color = 'grey') +
    theme_bw() +
    scale_fill_manual(values =c(brewer.pal(n = 3, name = 'PuRd'), # body/exon/tss
                              brewer.pal(n = 6, name = 'BrBG'),
                              'grey', 'grey'),
                    na.value = 'white', 
                    na.translate = F,
                    labels=c('Absent','Present')) +
    theme(
        axis.text.x = element_blank(), 
        plot.margin = margin(l= -1.8,unit="cm"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())  +
    scale_x_discrete(expand = c(0,0))+
    labs(x = '', y = '', fill = '')
cpg
}
```

