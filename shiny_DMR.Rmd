---
title: "shiny_DMR"
output: html_document
---

#set up
```{r}
#install.packages('rsconnect')
library(rsconnect)
library(shiny)
library(ggplot2)

rsconnect::setAccountInfo(name='yifan7', token='52E1037550A7AA68252579A98EE8AA38', secret='+NlrJysSVZHa5LQQb9slmYRDXExPfjF0QbxMjUH1')
library(DT)
```

#ui
```{r}
ui <- fluidPage(
  #main title
  titlePanel("A Tool for Interpreting Differentially Methylated CpG Sites"),
  br(), # create a space line
  br(),
  hr(), #create a line
  
  #UI layout
  sidebarLayout(
  sidebarPanel(
    
           #miRNA name input
           selectizeInput('name', 'CpG Site', choices = NULL,multiple = TRUE,options = list(placeholder='Enter CpG site names' )),
           #create action button
  
           selectizeInput('gene', 'Gene', choices = NULL, multiple = TRUE,options = list(placeholder='Enter a gene name',onInitialize = I('function() { this.setValue(""); }'))),
           actionButton("submit", "Submit"),
           br(), # add a space line
           br(), # add a space line
           hr(),#create a horizontal line
           checkboxGroupInput('checkbox', 'Information in datatable to show', names(anno), selected = c('cpg', "Cell_type" ,'chr','pos','UCSC_RefGene_Name',"Islands_Name" ,"Relation_to_Island" ))
          
           ), 
  
  mainPanel(
  hr(),
  #create a data table to show cpg site information 
  dataTableOutput('info'),
  #boxplot that shows tissue and trimester
  plotOutput('boxplot_tissue'),
  plotOutput('boxplot_trimester'),
  br(),
  plotOutput('single_plot_tissue'),
  plotOutput('single_plot_trimester')
  )
  )
)

server <- function(input, output, session) {
    #searching list
    updateSelectizeInput(session = session, inputId = 'name', choices = unique(DMC$cpg), server = TRUE)
    updateSelectizeInput(session = session, inputId = 'gene', choices = gene$gene, server = TRUE)
      
    #produce output when click submit button
    event_submit <- eventReactive(input$submit, {input$name})
    event_submit2 <- eventReactive(input$submit, {input$gene})
    empty_df <- data[0,]
    #related cpg site
    b <- reactive(fn_cpg(event_submit2()))

    #cpg site information datatable
    output$info <- DT::renderDataTable(
      { if (input$submit == FALSE) return(DT:: datatable(empty_df, options = list(paging = FALSE, searching = FALSE)))
        DT::datatable(cpg_info_total(cpg_name = event_submit(), gene_name = event_submit2())[,input$checkbox, drop = FALSE],
        selection = 'single',
        callback = JS("table.on('click.dt', 'tr',
                  function() {
                  Shiny.onInputChange('rows', table.rows('.selected').data().toArray());
                  });"))%>% formatStyle(1, cursor = 'pointer')
       
      }
    )
    observeEvent(input$all, {output$info <- DT:: renderDataTable(
      {
       DT::datatable(cpg_info_total(cpg_name = event_submit(), gene_name = event_submit2())[,input$checkbox, drop = FALSE],
        selection = 'single',
        callback = JS("table.on('click.dt', 'tr',
                  function() {
                  Shiny.onInputChange('rows', table.rows('.selected').data().toArray());
                  });"))%>% formatStyle(1, cursor = 'pointer')
      }
    )})
    
    #boxplot
    ##retrive cpg name when click the datatable
    event_cpg <- eventReactive(input$info_cell_clicked, {c_info = input$info_cell_clicked
    c_info$value})
  
    #boxplot
    output$boxplot_tissue <- renderPlot(
      { 
        boxplot_tissue_total(cpg_name = event_submit(), gene_name = event_submit2())
      }
    )
    output$boxplot_trimester <- renderPlot(
      {
        boxplot_trimester_total(cpg_name = event_submit(), gene_name = event_submit2())
      }
    )
    output$single_plot_tissue <- renderPlot(
      {
        if (!is.null(event_cpg()))
        {
          boxplot_tissue_single(event_cpg())
        }
      }
    )
    output$single_plot_trimester <- renderPlot(
      {
        if (!is.null(event_cpg()))
        {
          boxplot_trimester_single(event_cpg())
        }
      }
    )

}
shinyApp(ui, server)
```

