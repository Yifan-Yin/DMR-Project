---
title: "shiny_DMR"
output: html_document
---

#set up
```{r}
#install.packages('rsconnect')
library(rsconnect)
library(shiny)
rsconnect::setAccountInfo(name='yifan7', token='52E1037550A7AA68252579A98EE8AA38', secret='+NlrJysSVZHa5LQQb9slmYRDXExPfjF0QbxMjUH1')
library(DT)
```

#ui
```{r}
ui <- fluidPage(
  #main title
  titlePanel("Placental Cell Methylome Browser"),
  br(), # create a space line
  br(),
  hr(), #create a line
  
  #UI layout
  sidebarLayout(
  sidebarPanel(
           #app description
           code('Description here'),
           #miRNA name input
           selectizeInput('name', 'CpG Sites', choices = NULL,multiple = TRUE,options = list(placeholder='Enter CpG site names' )),
           #gene input  
           selectizeInput('gene', 'Gene', choices = NULL, multiple = FALSE,options = list(placeholder='Enter a gene name',onInitialize = I('function() { this.setValue(""); }'))),
           actionButton("submit", "Submit"),
           br(),
           br(),
           #cpgs related to selected gene
           selectizeInput('cpg', 'CpGs related to the selected gene', choices = NULL,multiple = TRUE),
           actionButton('submit2', 'Submit'),
           
           br(), # add a space line
           br(), # add a space line
           hr(),#create a horizontal line
           checkboxGroupInput('checkbox', 'Information in table to show', names(anno1), selected = names(anno1)[-10:-12])
          
           ), 
  
  mainPanel(
  hr(),
  #create a data table to show cpg site information 
  div(dataTableOutput('info'), style = "font-size:85%"),
  plotOutput('plot_cpg', height = '650px'),
  #boxplot that shows tissue and trimester
  selectInput('num','Number of CpGs to plot', choices = c(25, 50, 75,100)),
  plotOutput('boxplot_total',  height = '650px'),
  plotOutput('boxplot_individual')
  )
  )
)

server <- function(input, output, session) {
    #searching list
    updateSelectizeInput(session = session, inputId = 'name', choices = cpg$value, server = TRUE)
    updateSelectizeInput(session = session, inputId = 'gene', choices = gene$gene, selected = '',server = TRUE)
      
    #produce output when click submit button
    event_submit <- eventReactive(input$submit, {input$name})
    event_submit2 <- eventReactive(input$submit, {input$gene})
    empty_df <- anno[0,]

    #cpg site information datatable
    output$info <- DT::renderDataTable(
      { if (input$submit == FALSE) return(DT:: datatable(empty_df, options = list(paging = FALSE, searching = FALSE)))
        DT::datatable(cpg_info_total(cpg_name = event_submit(), gene_name = event_submit2())[,input$checkbox, drop = FALSE], options = list(pageLength = 5),
        selection = 'single',
        rownames = FALSE,
        
        callback = JS("table.on('click.dt', 'tr',
                  function() {
                  Shiny.onInputChange('rows', table.rows('.selected').data().toArray());
                  });"))%>% formatStyle(1, cursor = 'pointer')
       
      }
    )
    
    #gene cpg plots
    output$plot_cpg <- renderPlot(
      {
        stat_plot(cpg_name = event_submit(), gene_name = event_submit2())
      }
    )

    #boxplot
    output$boxplot_total <- renderPlot(
      { 
        boxplot_total(cpg_name = event_submit(), gene_name = event_submit2(), nrow = (as.numeric(input$num) %/% 7))
      }
    )
    
    #related cpg site
    b <- reactive(fn_cpg(event_submit2()))
    #searching list (cpg sites related to selected gene)
    observe(
      {
    updateSelectizeInput(session = session, inputId = 'cpg', choices = b(), server = TRUE, selected = '')
        
      })
    ##retrive cpg name when click the datatable
    event_cpg <- eventReactive(input$info_cell_clicked, {c_info = input$info_cell_clicked
    c_info$value})
    event_submit3 <- eventReactive(input$submit2, {input$cpg})
    
    observe(output$boxplot_individual <- renderPlot(
      {
        if (!is.null(event_cpg()))
        {
          boxplot_individual(event_cpg())
        }
        else if(!is.null(event_submit3()))
        {
          boxplot_individual(event_submit3())
        }
      }
    ))

}
shinyApp(ui, server)
```

