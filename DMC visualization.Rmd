---
title: "DMC Visualization"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#package setup

```{r}

library(kableExtra)
library(readr)
library(tidyverse)
library(reshape2) 
```

#data setup
```{r}
#read DMC values from all tests
DMC_alltest <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_2_Term_DMCs_alltests.rds')
#read processed DMC values
data <- read_xlsx('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_2_Term_DMCs.xlsx')
#read beta values from all tests
#beta <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_2_betas_term.rds')

#anno
anno <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\3_1_annotation.rds')

#get new annotation
##only significant tests
anno <- anno[, -12:-19]
data <- select(data, cpg, Cell_type, fdr,bonferroni, estimate_b) %>% merge(anno)
##all tests
DMC <- select(DMC_alltest, cpg, Cell_type, fdr,bonferroni, estimate_b) %>% merge(anno)

#pull out cpg site name for the search list use
cpgname <- unique(DMC$cpg)

#statistic data
stat <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\3_1_betas_cell_mean_sd.rds')


#DNA methylation data
DNAm <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\1_4_betas_noob_filt_XYkeep.rds')


#color code
color_code <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_3_color_code.rds')
color_code_tissue <- setNames(color_code$Colors_Tissue, color_code$label)

#pData
pDat <- readRDS('Z\\Victor\\Projects/NIH - cells\\data\\main\\interim\\2_3_pDat_contam.rds')
pDat <- pDat %>%
  mutate(Tissue = case_when(
    !(Tissue %in% c('Villi', 'Villi maternal', 'Syncytiotrophoblast')) ~ paste(Tissue, 'cs'),
    Tissue == 'Syncytiotrophoblast' ~ 'Trophoblasts enz',
    TRUE ~ Tissue
  )) 
pDat <- pDat %>% select(Trimester, Tissue, Sentrix)
rownames(pDat) <- pDat$Sentrix
#pull out gene name for the search list use
gene <- as.matrix(data$UCSC_RefGene_Name)
a <- apply(gene, 1, strsplit,';')
a <- unlist(a)
gene <- a[!duplicated(a)]
gene <- gene[!is.na(gene)]
gene <- as.data.frame(gene)
#another way
#tibble(gene = str_split(data$UCSC_RefGene_Name, ';') %>%
        #unlist() %>%
         #unique()) %>%
  #filter(!is.na(gene))
#for test use
cpg_1 <-c("cg23235736", "cg17315703", "cg14623715")

gene_1 <- c('PCID2')
```


#boxplot
##single boxplot (for click use)
```{r}
#boxplots which show beta values based on cell types
boxplot_cpg_tissue <- function(cpg_name){
  
    #get sample cell types and trimester
    cpg <- sample_info_cpg(cpg_name)
    
    #boxplot
    boxplot_tissue(cpg)
}
#boxplot which show beta values based on trimester
boxplot_cpg_trimester <- function(cpg_name){
  
    #get sample cell types and trimester
    cpg <- sample_info_cpg(cpg_name)
    
    #boxplot
    boxplot_trimester(cpg)
}

```

##boxplot(multiple plots for overview)
```{r}
#boxplot
boxplot_tissue_total <- function(cpg_name = NULL, gene_name = NULL){
  #when only have gene input
  if(is.null(cpg_name)){
  cpg <- sample_info_gene(gene_name)
  }
  
  #when only have cpg input
  else if(is.null(gene_name)){
  cpg <- sample_info_cpg(cpg_name)  
  }
  
  #when have both cpg and gene input
  else{
  cpg <- rbind(sample_info_cpg(cpg_name),sample_info_gene(gene_name))
  }
  #boxplot
  boxplot_tissue(cpg)
}


boxplot_trimester_total <- function(cpg_name = NULL, gene_name = NULL){
  #when only have gene input
  if(is.null(cpg_name)){
  cpg <- sample_info_gene(gene_name)
  }
  
  #when only have cpg input
  else if(is.null(gene_name)){
  cpg <- sample_info_cpg(cpg_name)  
  }
  
  #when have both cpg and gene input
  else{
  cpg <- rbind(sample_info_cpg(cpg_name),sample_info_gene(gene_name))
  }
  #boxplot
  boxplot_trimester(cpg)
}

```

##Get sample information(only cpg input)
```{r}
#get sample information (cell types and trimester)
sample_info_cpg <- function(cpg_name){
  
    #get input cpg site beta values
    cpg <- DNAm[cpg_name,]
    
    #get sample cell types and tri
    
    cpg <- DNAm[cpg_1,] %>% t() %>% cbind(pDat) %>% gather(cpg, beta, contains('cg'))
    cpg
}
```

##Get sample information(only gene input)
```{r}
#information for producing boxplot which shows beta values of cpg sites related input genes
sample_info_gene <- function(gene_name){
  #get related cpg sites
  cpg_name <- DMC[grepl(gene_name, DMC$genes_symbol),]
  #get sample cell types and tri
  cpg <- cpg_name$cpg %>% sample_info_cpg()
  cpg
  
}

```

##boxplot helper function
```{r}
#boxplot function
boxplot_tissue <- function(cpg){
  ggplot(cpg, aes(x=Tissue, y=beta, fill = Tissue)) +
      geom_violin()+
      geom_jitter(aes(color = Tissue), alpha = 0.5, show.legend = F) +
      facet_wrap(.~cpg)+ 
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust =1))+
      labs(x = 'Cell Types', y ='beta')
}

boxplot_trimester <- function(cpg){
  ggplot(cpg, aes(x=Trimester, y=beta, fill = Trimester)) +
      geom_violin()+
      geom_jitter(aes(color = Trimester), alpha = 0.5, show.legend = F) +
      facet_wrap(.~cpg)+ 
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust =1))+
      labs(x = 'Trimester', y ='beta')
}
```


#datatable
##only cpg input
```{r}
#datatable which shows all DMC tests
cpg_info <- function(cpg_name){
#get input cpg site information
cpg <- filter(DMC, cpg %in% cpg_name) %>% arrange(cpg)

cpg
}


#datatable which shows only significant tests
cpg_info_sig <- function(cpg_name){
#get input cpg site information
cpg <- filter(data, cpg %in% cpg_name) 
  
cpg
}


```
##only gene input
```{r}
#datatable shows all cpg sites related to input gene
cpg_info_gene <- function(gene_name){

    #get cpgs sites related to input genes
    cpg_name <- filter(DMC, grepl(gene_name, genes_symbol))
    cpg_name <- cpg_name$cpg %>% unique()

  cpg <- filter(DMC, cpg %in% cpg_name)%>% arrange(cpg)
  cpg
}

#datatable shows significant cpg sites related to input gene
cpg_info_gene_sig <- function(gene_name){

    #get cpgs sites related to input genes
    cpg_name <- filter(data, grepl(gene_name, genes_symbol))
    cpg_name <- cpg_name$cpg %>% unique()

    cpg <- filter(data, cpg %in% cpg_name) %>% arrange(cpg)

cpg
}

```
##both cpg and gene input
```{r}
#datatable shows all tests
cpg_info_total <- function(cpg_name = NULL, gene_name = NULL){
    if (is.null(cpg_name)){
      info <- cpg_info_gene(gene_name)
    }
    else if (is.null(gene_name)){
      info <- cpg_info(cpg_name)
    }
    else {
      info1 <- cpg_info(cpg_name)
      info2 <- cpg_info_gene(gene_name)
      info <- merge(info1, info2, all= TRUE)
    }
  info
}


#datatable shows only significant tests
cpg_info_total_sig <- function(cpg_name = NULL, gene_name = NULL){
    if (is.null(cpg_name)){
      info <- cpg_info_gene_sig(gene_name)
    }
    else if (is.null(gene_name)){
      info <- cpg_info_sig(cpg_name)
    }
    else {
      info1 <- cpg_info_sig(cpg_name)
      info2 <- cpg_info_gene_sig(gene_name)
      info <- merge(info1, info2, all= TRUE)
    }
  info
}
```


#heatmap
##only cpg input
```{r}
#heatmap to view test result
heatmap_cpg <- function(cpg_name){

  cpg <- filter(DMC_alltest, cpg %in% cpg_name)
  
    cpg<- select(cpg, cpg, Cell_type, bonferroni,estimate_b)
    acc <- NULL
    for (i in 1:nrow(cpg))
    {
      if(cpg[i,3] < 0.001 & abs(cpg[i,4]) >0.5)
      {
        bool <- 1
      }
      else
      {
        bool <- 0
      }
      acc <- c(acc, bool)
    }
    cpg <- mutate(cpg, bool = acc)
    cpg$cpg <- as.character(cpg$cpg)
    cpg$cpg <- factor(cpg$cpg, levels = unique(cpg$cpg))
    cpg$Cell_type <- as.factor(cpg$Cell_type)
    cpg$bool<- as.factor(cpg$bool)
cpg
}
```
##only gene input
```{r}
#heatmap
heatmap_gene <- function(gene_name){

    #get cpgs sites related to input genes
    cpg_name <- filter(DMC_alltest, grepl(gene_name, UCSC_RefGene_Name))
    cpg_name <- cpg_name$cpg %>% unique()

    cpg <- heatmap_cpg(cpg_name)
    cpg
}
```
##both cpg and gene input
```{r}
#heatmap
heatmap_total <- function(cpg_name = NULL, gene_name = NULL){
  if (is.null(cpg_name)){
  cpg <- heatmap_gene(gene_name)
  plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types', fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant'))
  plot
  }
  else if (is.null(gene_name)){
  cpg <- heatmap_cpg(cpg_name)
  plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types',fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant'))  
  plot
  }
  else{
    gene_data <- heatmap_gene(gene_name)
    cpg_data <- heatmap_cpg(cpg_name)
    cpg <- merge(gene_data, cpg_data, all = TRUE)
    plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types',fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant')) 
    plot
  }
}
```

