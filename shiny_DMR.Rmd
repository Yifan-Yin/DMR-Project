---
title: "shiny_DMR"
output: html_document
---

#set up
```{r}
#install.packages('rsconnect')
#install.packages('shinyjs')
library(rsconnect)
library(shiny)
rsconnect::setAccountInfo(name='yifan7', token='52E1037550A7AA68252579A98EE8AA38', secret='+NlrJysSVZHa5LQQb9slmYRDXExPfjF0QbxMjUH1')
library(DT)
library(shinyjs)
```

#UI
```{r}
ui <- fluidPage(
  useShinyjs(),
  #main title
  titlePanel("Placental Cell Methylome Browser"),
  hr(), #create a line
  
  #UI layout
  sidebarLayout(
      sidebarPanel(
          
           # relative width out of 12 units
           width = 3,
       
           #app description
           p('Welcome to the Placental Cell Methylome Browser!'),
           p('To start, select CpGs or a gene.', span(tags$a(href = '#footer_1', 
                                                             tags$sup(1), 
                                                             style = 'color:blue'))),
           hr(),
           
           #tabset panel
           tabsetPanel(type = 'tabs', id = 'tabs',
                       
           #page of gene input 
           tabPanel('Gene Input',
                    #gene search list
                    selectizeInput('gene_name', 'Gene', 
                          choices = NULL, 
                          multiple = FALSE,
                          options = list(placeholder='Enter a gene name',
                                         onInitialize = I('function() { this.setValue(""); }'))),
                    #action button to submit and reset input
                    actionButton("submit_geneInput", "Submit"),
                    actionButton('reset_geneInput','Reset'),
                    br(), # add a space line
                    hr(), # create a horizontal line
           
                    p('If a specific gene is selected, then you can also display specific associated-CpGs'),
           
                    #cpgs search list related to selected gene
                    selectizeInput('cpg', 'CpGs related to the selected gene', 
                          choices = NULL,
                          multiple = TRUE),
                    #action button to submit and reset input
                    actionButton('submit_cpg_geneInput', 'Submit'),
                    actionButton('reset_cpg_geneInput','Reset')),
                       
            #page of cpgs input
            tabPanel('CpG Input',
                    #cpg search list
                    selectizeInput('cpg_name', 'CpG Sites', 
                          choices = NULL,
                          multiple = TRUE,
                          options = list(placeholder='Enter CpG site names' )),
                    #action button to submit and reset input
                    actionButton("submit_cpgInput", "Submit"),
                    actionButton('reset_cpgInput','Reset')),
                       
            #page of region input
                    tabPanel('Region Input',
                    #chromosome 
                    selectizeInput('chr','Chromosome',
                          choices = NULL,
                          multiple = FALSE,
                          options = list(placeholder = 'Enter a chromosome')),
                    #start point
                    numericInput('start', 'Start', value = NULL),
                    #end point
                    numericInput('end', 'End', value = NULL),
                    
                    #action button to submit and reset input
                    actionButton("submit_regionInput", "Submit"),
                    actionButton('reset_regionInput','Reset')
                                )
                       ),
           
           #create a blank line
           br(),
           #create a horizontal line
           hr(),
           #checkbox to select information shown in datatable
           checkboxGroupInput('checkbox', 
                              'Columns to show in CpG annotation table', 
                              names(anno), 
                              selected = names(anno)[-10:-12])
           ), 
  
  mainPanel(
    hr(),
    textOutput('text'),
    #create a data table to show cpg site information 
    div(dataTableOutput('dt_anno_cpg'), style = "font-size:85%"),
    
    hr(),
    
    # GENE PLOT
    plotOutput('annoplot'),
    
    hr(),
    
    # INDIVIDUAL CPG PLOT
    plotOutput('boxplot_selectedCpG')
  
    #boxplot that shows tissue and trimester
    #selectInput('num','Number of CpGs to plot', choices = c(25, 50, 75,100)),
    #plotOutput('boxplot_total',  height = '650px'),
    )
  ),
  
  #footer
  hr(),
  tags$h6(paste("[1] Only associated CpGs will be displayed when selecting a gene.",
                "This CpG-gene mapping is based on the Illumina-provided EPIC array annotation.", 
                id = "#footer_1"))
)


```

#Server
```{r}
server <- function(input, output, session) {
    #searching list of cpgs
    updateSelectizeInput(session = session, inputId = 'cpg_name', 
                         choices = cpg$value, server = TRUE)
    #searching list of genes
    updateSelectizeInput(session = session, inputId = 'gene_name', 
                         choices = gene$gene, selected = '',server = TRUE)
    #searching list of chromosome
    chr <- unique(anno$chr) %>% as.tibble()
    updateSelectizeInput(session = session, inputId = 'chr',
                         choices = chr$value, selected = '', server = TRUE)
      
    #get input info when click submit button
    get_geneInput <- eventReactive(input$submit_geneInput, {input$gene_name})
    get_cpgInput <- eventReactive(input$submit_cpgInput, {input$cpg_name})
    ##get_regionInput <- eventReactive(input$submit_regionInput, {})
    
    #reset button
    observeEvent(input$reset_cpgInput, {reset('cpg_name')})
    observeEvent(input$reset_geneInput, {reset('gene_name')})

    empty_df <- anno[0,]
    #datatable to show cpg annotation information 
    output$dt_anno_cpg <- DT::renderDataTable({ 
      if (input$submit_geneInput == FALSE & input$submit_cpgInput == FALSE & input$submit_regionInput == FALSE)
        return(DT:: datatable(empty_df, 
                              options = list(paging = FALSE, 
                                             searching = FALSE)))
      else if(input$tabs == 'Gene Input')
      {DT::datatable(make_datatable(gene_name = get_geneInput(), cpg_name = NULL)[,input$checkbox, 
                                                                drop = FALSE], 
                    options = list(pageLength = 5),
                    selection = 'single',
                    rownames = FALSE) %>% 
        formatStyle(1, cursor = 'pointer', color = 'blue')}
      else if(input$tabs == 'CpG Input')
        {DT::datatable(make_datatable(gene_name = NULL, cpg_name = get_cpgInput())[,input$checkbox, 
                                                                drop = FALSE], 
                    options = list(pageLength = 5),
                    selection = 'single',
                    rownames = FALSE) %>% 
        formatStyle(1, cursor = 'pointer', color = 'blue')}
      }
    )

    #gene cpg plots
    output$annoplot <- renderPlot(
      {
      if(input$tabs == 'Gene Input')
        {
        annoPlot_withTracks(cpg_name = NULL, gene_name = get_geneInput())
          }
      else if(input$tabs == 'CpG Input')
        {
        annoPlot_withTracks(cpg_name = get_cpgInput(), gene_name = NULL)
          }
          
      }

    )
    
    #related cpg site
    b <- reactive(find_cpgID(get_geneInput()))
    #searching list (cpg sites related to selected gene)
    observe(
      {
        updateSelectizeInput(session = session, 
                             inputId = 'cpg', 
                             choices = b(), 
                             server = TRUE, 
                             selected = '')
        
      })
    
    ##retrive cpg name when click the datatable
    get_cpgFromDatable <- eventReactive(input$submit_cpg_gene, {input$cpg})
    
    #produce boxplots of selected cpgs
    observeEvent(input$dt_anno_cpg_cell_clicked, 
                 {
                   c_info = input$dt_anno_cpg_cell_clicked
                   
                   output$boxplot_selectedCpG <- renderPlot(
      {
        if (!is.null(c_info$value))
        {
          boxplot_selected(c_info$value)
        }
        else if(!is.null(get_cpgFromDatable()))
        {
          boxplot_selected(get_cpgFromDatable())
        }
      }
    )
    })
    


}
shinyApp(ui, server)

```

