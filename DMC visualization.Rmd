---
title: "DMC Visualization"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#setup

Load libraries

```{r}
library(kableExtra)
library(readr)
library(tidyverse)
```

Load data

```{r}
#read DMC values from all tests
DMC_alltest <- readRDS('Z:/Victor/Projects/NIH - cells/data/main/interim/2_2_Term_DMCs_alltests.rds')
#read processed DMC values
data <- read_tsv('Z:/Victor/Projects/NIH - cells/data/main/processed/2_2_Term_DMCs.txt')
beta <- readRDS('Z:/Victor/Projects/NIH - cells/data/main/interim/2_2_betas_term.rds')

# this doesn't match your cell factors levels currently, will need to change
color_code <- readRDS('Z:/Victor/Projects/NIH - cells/data/main/interim/2_3_color_code.rds')
color_code_tissue <- setNames(color_code$Colors_Tissue, color_code$label)

# load sample data
pDat <- readRDS('Z:/Victor/Projects/NIH - cells/data/main/interim/2_3_pDat_contam.rds')
pDat <- pDat %>%
  mutate(Tissue = case_when(
    !(Tissue %in% c('Villi', 'Villi maternal', 'Syncytiotrophoblast')) ~ paste(Tissue, 'cs'),
    Tissue == 'Syncytiotrophoblast' ~ 'Trophoblasts enz',
    TRUE ~ Tissue
  )) 
```

#data setup

```{r}
#pull out beta values from DM cpg sites
beta <- as.data.frame(beta)
beta_DMC <- beta[rownames(beta)%in% data$cpg,] ## Don't do this from now on

#check if the samples are the same
all(data$cpg%in% rownames(beta_DMC))
all(rownames(beta_DMC)%in% data$cpg)

#pull out cpg site name for the search list use
cpgname <- data$cpg

#pull out gene name for the search list use
gene <- as.matrix(data$UCSC_RefGene_Name)
a <- apply(gene, 1, strsplit,';')
a <- unlist(a)
gene <- a[!duplicated(a)]
gene <- gene[!is.na(gene)]
gene <- as.data.frame(gene)

#***
# tidy solution:
tibble(gene = str_split(data$UCSC_RefGene_Name, ';') %>%
         unlist() %>%
         unique()) %>%
  filter(!is.na(gene))

#for test use
cpg_1 <-c("cg23235736", "cg17315703", "cg14623715")
```

# Filter and reshape betas function

Would be good to keep the filtering and reshaping in a separate function to reduce redundant code, since it is being ran every single time

```{r}
prep_betas <- function(x) {
  
  # 1. filter betas to cpg input
  cpg <- beta[x,]
  
  # 2. get cell type --- note that in the future, can just add on the Tissue column from pDat, will supply later
  cpg <- colnames(cpg) %>% substr(7,15) %>% rbind(cpg)
  cpg <- t(cpg) %>% as_tibble() 
  colnames(cpg)[1] <- 'cell_types'
  cpg <- cpg %>% filter(!cell_types == 'vc' & !cell_types =='tro2' & !cell_types == 'vc_R1')
  cpg$cell_types <- as.factor(cpg$cell_types)
  cpg[,2:(length(x)+1)] <- select(cpg, -cell_types) %>% apply(2, as.numeric)
  
  # 3. reshape, I'd prefer you use dplyr::gather() over reshape2::melt
  cpg <- cpg %>% gather(cpg, beta, contains('cg'))
  
  return(cpg)
}
```

#boxplot

##only cpg input

```{r}
#Single plot function (produce a boxplot when click the cpg site name)
boxplot_singleplot <- function(cpg_name){
  
    #get input cpg site beta values
    cpg <- prep_betas(cpg_name)
    
    #boxplot
    ggplot(cpg, aes(x=cell_types, y=beta, fill = cell_types)) +
      geom_violin()+
      geom_jitter(aes(color = cell_types), alpha = 0.5, show.legend = F) +
      facet_wrap(.~cpg)+ 
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust =1))+
      labs(x = 'Cell Types', y ='beta')
}
```

##only gene input

```{r}
#information for producing boxplot which shows beta values of cpg sites related input genes
boxplot_gene <- function(gene_name){
 
    # get cpgs sites related to input genes
    cpg_name <- data[grep(gene_name, data$UCSC_RefGene_Name), ]
    cpg_name <- cpg_name$cpg
    
    # filter and reshape betas
    cpg <- prep_betas(cpg_name)
    
    cpg 
}
```
##both cpg and gene input
```{r}
#boxplot
boxplot_total <- function(cpg_name = NULL, gene_name = NULL){
  
  #when only have gene input
  if(is.null(cpg_name)){
  cpg <- boxplot_gene(gene_name)
  }
  
  #when only have cpg input
  else if(is.null(gene_name)){
  cpg <- prep_betas(cpg_name)  
  }
  
  #when have both cpg and gene input
  else{
  cpg <- rbind(boxplot_cpg(cpg_name), boxplot_gene(gene_name))
  }
  
  # generate output
  ggplot(cpg,aes(x=cell_types, y=beta))+
    geom_boxplot(aes(fill = cell_types))+
    facet_wrap(.~cpg)+ 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust =1))+
    labs(x = 'Cell Types', y ='beta', fill = 'Cell Types')
}

```

#datatable

##only cpg input

```{r}
#datatable which shows all DMC tests
cpg_info <- function(cpg_name){
#get input cpg site information
cpg <- filter(DMC_alltest, cpg %in% cpg_name) %>% arrange(cpg)

cpg
}
#datatable which shows only significant tests
cpg_info_sig <- function(cpg_name){
#get input cpg site information
cpg <- filter(data, cpg %in% cpg_name) 
  
cpg
}
```
##only gene input
```{r}
#datatable shows all cpg sites related to input gene
cpg_info_gene <- function(gene_name){
  for (i in 1:length(gene_name)) { 
    #get cpgsites related to input gene
    cpg_name <- DMC_alltest[grep(gene_name, DMC_alltest$UCSC_RefGene_Name),]
    cpg_name <- cpg_name$cpg
  }
  cpg <- filter(DMC_alltest, cpg %in% cpg_name)%>% arrange(cpg)
  cpg
}

#datatable shows significant cpg sites related to input gene
cpg_info_sig_gene <- function(gene_name){
  for (i in 1:length(gene_name)) { 
    #get cpg sites related to input gene
    cpg_name <- data[grep(gene_name, data$UCSC_RefGene_Name),]
    cpg_name <- cpg_name$cpg
    }

  cpg <- filter(DMC_alltest, cpg %in% cpg_name) %>% arrange(cpg)

cpg
}
```
##both input and gene input
```{r}
#datatable shows all tests
cpg_info_total <- function(cpg_name = NULL, gene_name = NULL){
    if (is.null(cpg_name)){
      info <- cpg_info_gene(gene_name)
    }
    else if (is.null(gene_name)){
      info <- cpg_info(cpg_name)
    }
    else {
      info1 <- cpg_info(cpg_name)
      info2 <- cpg_info_gene(gene_name)
      info <- merge(info1, info2, all= TRUE)
    }
  info
}

#datatable shows only significant tests
cpg_info_total_sig <- function(cpg_name = NULL, gene_name = NULL){
    if (is.null(cpg_name)){
      info <- cpg_info_sig_gene(gene_name)
    }
    else if (is.null(gene_name)){
      info <- cpg_info_sig(cpg_name)
    }
    else {
      info1 <- cpg_info_sig(cpg_name)
      info2 <- cpg_info_sig_gene(gene_name)
      info <- merge(info1, info2, all= TRUE)
    }
  info
}
```


#heatmap
##only cpg input
```{r}
#heatmap to view test result
heatmap_cpg <- function(cpg_name){

  cpg <- filter(DMC_alltest, cpg %in% cpg_name)
  
    cpg<- select(cpg, cpg, Cell_type, bonferroni,estimate_b)
    acc <- NULL
    for (i in 1:nrow(cpg))
    {
      if(cpg[i,3] < 0.001 & abs(cpg[i,4]) >0.5)
      {
        bool <- 1
      }
      else
      {
        bool <- 0
      }
      acc <- c(acc, bool)
    }
    cpg <- mutate(cpg, bool = acc)
    cpg$cpg <- as.character(cpg$cpg)
    cpg$cpg <- factor(cpg$cpg, levels = unique(cpg$cpg))
    cpg$Cell_type <- as.factor(cpg$Cell_type)
    cpg$bool<- as.factor(cpg$bool)
cpg
}
```
##only gene input
```{r}
#heatmap
heatmap_gene <- function(gene_name){
  for (i in 1:length(gene_name)) { 
    #pull out beta values based on cell types
    cpg_name <- data[grep(gene_name, data$UCSC_RefGene_Name),]
    cpg_name <- cpg_name$cpg
  }
  cpg <- heatmap_cpg(cpg_name)
cpg
}
```
#both cpg and gene input
```{r}
#heatmap
heatmap_total <- function(cpg_name = NULL, gene_name = NULL){
  if (is.null(cpg_name)){
  cpg <- heatmap_gene(gene_name)
  plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types', fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant'))
  plot
  }
  else if (is.null(gene_name)){
  cpg <- heatmap_cpg(cpg_name)
  plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types',fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant'))  
  plot
  }
  else{
    gene_data <- heatmap_gene(gene_name)
    cpg_data <- heatmap_cpg(cpg_name)
    cpg <- merge(gene_data, cpg_data, all = TRUE)
    plot <- ggplot(cpg) + geom_tile(aes(x = cpg, y = Cell_type, fill = bool), colour = 'white') + labs(y = 'Cell Types',fill ='DMC Result') + scale_fill_manual(
                    values=c('Orange','Red'),
                    labels=c('Insignificant','Significant')) 
    plot
  }
}
```

