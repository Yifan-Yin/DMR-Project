---
title: "shiny_DMR"
output: html_document
---

#set up
```{r}
#install.packages('rsconnect')
library(rsconnect)
library(shiny)
library(ggplot2)

rsconnect::setAccountInfo(name='yifan7', token='52E1037550A7AA68252579A98EE8AA38', secret='+NlrJysSVZHa5LQQb9slmYRDXExPfjF0QbxMjUH1')
library(DT)
```

#ui
```{r}
ui <- fluidPage(
  #main title
  titlePanel("A Tool for Interpreting Differentially Methylated CpG Sites"),
  br(), # create a space line
  br(),
  hr(), #create a line
  
  #UI layout
  sidebarLayout(
  sidebarPanel(
    
           #miRNA name input
           selectizeInput('name', 'CpG Site', choices = NULL,multiple = TRUE,options = list(placeholder='Enter CpG site names' )),
           #create action button
  
           selectizeInput('gene', 'Gene', choices = NULL, multiple = TRUE, options = list(placeholder='Enter gene names' )),
           actionButton("submit", "Submit"),
           br(), # add a space line
           br(), # add a space line
           hr(),#create a horizontal line
           checkboxGroupInput('checkbox', 'CpG site annotation in datatable to show', cpg_anno, selected = c('cpg','chr','pos',"UCSC_RefGene_Name" ,"Islands_Name","Relation_to_Island" ))
          
           ), 
  
  mainPanel(

  br(),
  dataTableOutput('info'),
  #create a data table to show cpg site information         
  plotOutput('plot_beta'),
  br(),
  plotOutput('heatmap'),
  textOutput('text')

  )
  )
)

server <- function(input, output, session) {
    updateSelectizeInput(session = session, inputId = 'name', choices = data$cpg, server = TRUE)
    updateSelectizeInput(session = session, inputId = 'gene', choices = gene$gene, server = TRUE)
    proxy = dataTableProxy('info')
    #produce output when click submit button
    observeEvent(input$submit, {proxy %>% selectRows(NULL)})
    event_submit <- eventReactive(input$submit, {input$name})
    event_submit2 <- eventReactive(input$submit, {input$gene})
    empty_df <- data[0,]
    #cpg site information datatable
    output$info <- DT::renderDataTable(
      { if (input$submit == FALSE) return(DT:: datatable(empty_df, options = list(paging = FALSE, searching = FALSE)))
        DT::datatable(cpg_info_total(cpg_name = event_submit(), gene_name = event_submit2())[,input$checkbox, drop = FALSE],
        selection = 'single',
        callback = JS("table.on('click.dt', 'tr',
                  function() {
                  Shiny.onInputChange('rows', table.rows('.selected').data().toArray());
                  });"))
       
      }
    )

    #retrive cpg name when click the datatable
    ##method 1 : can select multiple rows but cannot cancel the selection. need to find the solution
    cpg <- reactive({a <- input$rows
    a <- a[grep('cg',a)]})
    
    ##method 2 : single selection
    event_cpg <- eventReactive(input$info_cell_clicked, {c_info = input$info_cell_clicked
    c_info$value})
    #boxplot
    output$plot_beta <- renderPlot(
      { if (is.null(event_cpg())){
        box_plot(cpg_name = event_submit(), gene_name = event_submit2())
      } 

        else{
        boxplot_beta(cpg_name =  event_cpg())
        }
      }
    )
   

}
shinyApp(ui, server)
```

